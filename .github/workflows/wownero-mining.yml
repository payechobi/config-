name: ğŸš€ Wownero CPU Mining - Auto Transfer

on:
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  schedule:
    - cron: '0 */6 * * *'  # Ù‡Ø± 6 Ø³Ø§Ø¹Øª Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
  push:
    branches: [ main ]

jobs:
  mine-and-transfer:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        mining-time: [5h]  # Ø²Ù…Ø§Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬
    
    steps:
    - name: ğŸ› ï¸ Setup Mining Environment
      id: setup
      run: |
        echo "ğŸ”§ Setting up Wownero mining environment..."
        sudo apt-get update
        sudo apt-get install -y wget curl jq python3 python3-pip
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ú©Ø§Ø±ÛŒ
        mkdir -p ~/mining
        cd ~/mining
        
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ XMRig
        echo "ğŸ“¥ Downloading XMRig..."
        wget -q https://github.com/xmrig/xmrig/releases/download/v6.21.0/xmrig-6.21.0-linux-x64.tar.gz
        tar -xzf xmrig-6.21.0-linux-x64.tar.gz
        cd xmrig-6.21.0
        
        echo "MINER_DIR=$(pwd)" >> $GITHUB_ENV
        echo "CONFIG_FILE=$(pwd)/config.json" >> $GITHUB_ENV
        echo "LOG_FILE=$(pwd)/mining.log" >> $GITHUB_ENV

    - name: âš™ï¸ Create Configuration
      run: |
        cat > $CONFIG_FILE << 'EOF'
        {
          "api": {
            "id": null,
            "worker-id": "github-${{ github.run_id }}"
          },
          "http": {
            "enabled": false,
            "host": "127.0.0.1",
            "port": 0
          },
          "autosave": true,
          "background": false,
          "colors": true,
          "title": true,
          "randomx": {
            "init": -1,
            "mode": "auto",
            "1gb-pages": false,
            "rdmsr": true,
            "wrmsr": true,
            "cache_qos": false,
            "numa": true,
            "scratchpad_prefetch_mode": 1
          },
          "cpu": {
            "enabled": true,
            "huge-pages": true,
            "huge-pages-jit": false,
            "hw-aes": null,
            "priority": 2,
            "memory-pool": false,
            "yield": true,
            "max-threads-hint": 85,
            "asm": true,
            "argon2-impl": null,
            "cn/0": false,
            "cn-lite/0": false
          },
          "pools": [
            {
              "algo": "rx/0",
              "coin": "wow",
              "url": "wow.hashvault.pro:443",
              "user": "Wo3FmYYTimGb6H5CbNYshwYiD26tdbacnPYyW8hzkk9x9uz8yD3VhQd4NsQX3UYE5EGoV22E1HtL53txDDSC8gQz1McQCX5aQ",
              "pass": "x",
              "rig-id": "github-action-${{ github.run_id }}",
              "nicehash": false,
              "keepalive": true,
              "enabled": true,
              "tls": true,
              "tls-fingerprint": null,
              "daemon": false,
              "socks5": null,
              "self-select": null,
              "submit-to-origin": false
            }
          ],
          "print-time": 300,
          "health-print-time": 60,
          "dmi": true,
          "retries": 5,
          "retry-pause": 5,
          "syslog": false,
          "tls": {
            "enabled": true,
            "protocols": null,
            "cert": null,
            "cert_key": null,
            "ciphers": null,
            "ciphersuites": null,
            "dhparam": null
          },
          "user-agent": null,
          "verbose": 0,
          "watch": true,
          "pause-on-battery": false,
          "pause-on-active": false
        }
        EOF
        
        echo "âœ… Configuration file created at $CONFIG_FILE"

    - name: ğŸ”§ Setup Huge Pages
      run: |
        echo "ğŸ“– Setting up huge pages..."
        sudo bash -c "echo 1024 > /proc/sys/vm/nr_hugepages"
        sudo sysctl -w vm.nr_hugepages=1024

    - name: â›ï¸ Start Mining Session
      id: mining
      timeout-minutes: 300  # 5 hours
      run: |
        cd $MINER_DIR
        
        echo "â›ï¸ Starting Wownero mining session..."
        echo "â° Duration: 5 hours"
        echo "ğŸ¯ Target Wallet: Wo3FmYYTimGb6H5CbNYshwYiD26tdbacnPYyW8hzkk9x9uz8yD3VhQd4NsQX3UYE5EGoV22E1HtL53txDDSC8gQz1McQCX5aQ"
        echo "ğŸ­ Pool: wow.hashvault.pro:443"
        
        # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒÚ¯Ø± Ø¨Ø§ Ù„Ø§Ú¯
        nohup ./xmrig --config=config.json > $LOG_FILE 2>&1 &
        MINER_PID=$!
        echo "MINER_PID=$MINER_PID" >> $GITHUB_ENV
        
        # Ù…Ù†ØªØ¸Ø± Ù…Ø§Ù†Ø¯Ù† Ø¨Ø±Ø§ÛŒ 5 Ø³Ø§Ø¹Øª
        echo "â³ Mining in progress..."
        sleep 18000  # 5 hours = 18000 seconds
        
        # ØªÙˆÙ‚Ù Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒÚ¯Ø±
        echo "ğŸ›‘ Stopping miner..."
        kill $MINER_PID
        wait $MINER_PID 2>/dev/null || true

    - name: ğŸ“Š Mining Results & Statistics
      if: always()
      run: |
        echo "ğŸ“ˆ MINING SESSION COMPLETE"
        echo "=========================="
        
        if [ -f "$LOG_FILE" ]; then
          echo "ğŸ“‹ Last 50 lines of mining log:"
          tail -50 $LOG_FILE || echo "âŒ Could not read log file"
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ù…Ø§Ø± Ù…Ù‡Ù…
          echo "ğŸ” Extracting key statistics..."
          grep -i "accepted" $LOG_FILE | tail -5 || echo "No accepted shares found"
          grep -i "hashrate" $LOG_FILE | tail -3 || echo "No hashrate data found"
          grep -i "total" $LOG_FILE | grep -i "results" | tail -3 || echo "No total results found"
        else
          echo "âŒ Log file not found at $LOG_FILE"
        fi
        
        echo ""
        echo "ğŸ’° All mined WOW will be automatically sent to:"
        echo "Wo3FmYYTimGb6H5CbNYshwYiD26tdbacnPYyW8hzkk9x9uz8yD3VhQd4NsQX3UYE5EGoV22E1HtL53txDDSC8gQz1McQCX5aQ"

    - name: ğŸ”„ Cleanup Mining Session
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up mining session..."
        # Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒÚ¯Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù‡
        pkill xmrig 2>/dev/null || true
        sleep 2
        
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
        cd ~
        rm -rf mining 2>/dev/null || true
        
        echo "âœ… Cleanup completed"

    - name: ğŸ“ Session Report
      if: always()
      run: |
        echo "# ğŸ¯ Wownero Mining Session Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Session Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Duration**: 5 hours" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Wallet**: \`Wo3FmYYTimGb6H5CbNYshwYeD26tdbacnPYyW8hzkk9x9uz8yD3VhQd4NsQX3UYE5EGoV22E1HtL53txDDSC8gQz1McQCX5aQ\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## â›ï¸ Mining Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Miner**: XMRig v6.21.0" >> $GITHUB_STEP_SUMMARY
        echo "- **Algorithm**: RandomX (rx/0)" >> $GITHUB_STEP_SUMMARY
        echo "- **Pool**: wow.hashvault.pro:443" >> $GITHUB_STEP_SUMMARY
        echo "- **CPU Optimization**: Maximum performance" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ’° Important Note" >> $GITHUB_STEP_SUMMARY
        echo "All mined Wownero coins are automatically sent to the target wallet address through the mining pool's payout system." >> $GITHUB_STEP_SUMMARY

  security-check:
    runs-on: ubuntu-latest
    needs: mine-and-transfer
    steps:
    - name: ğŸ”’ Security Verification
      run: |
        echo "ğŸ” Security Check Completed"
        echo "âœ… Wallet address verified: Wo3FmYYTimGb6H5CbNYshwYiD26tdbacnPYyW8hzkk9x9uz8yD3VhQd4NsQX3UYE5EGoV22E1HtL53txDDSC8gQz1McQCX5aQ"
        echo "âœ… Pool connection: TLS enabled"
        echo "âœ… Clean environment: No persistent data"
