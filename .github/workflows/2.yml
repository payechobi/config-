name: ğŸš€ Wownero CPU Mining with Auto-Transfer

on:
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  schedule:
    - cron: '0 */6 * * *'  # Ù‡Ø± 6 Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø±

env:
  WALLET_ADDRESS: "Wo3FmYYTimGb6H5CbNYshwYiD26tdbacnPYyW8hzkk9x9uz8yD3VhQd4NsQX3UYE5EGoV22E1HtL53txDDSC8gQz1McQCX5aQ"
  MINING_DURATION: "5h"
  POOL_URL: "wow.hashvault.pro:443"
  WORKER_NAME: "github-actions-miner"

jobs:
  mine-and-transfer:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ› ï¸ Setup Environment
      id: setup
      run: |
        echo "ğŸ”§ Setting up mining environment..."
        sudo apt-get update
        sudo apt-get install -y wget tar curl jq
        echo "MINER_VERSION=2.7.0" >> $GITHUB_ENV
        echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: ğŸ“¥ Download SRBMiner
      run: |
        echo "ğŸ“¥ Downloading SRBMiner-Multi..."
        wget -q https://github.com/doktor83/SRBMiner-Multi/releases/download/$MINER_VERSION/SRBMiner-Multi-$MINER_VERSION-Linux.tar.xz
        tar -xf SRBMiner-Multi-$MINER_VERSION-Linux.tar.xz
        cd SRBMiner-Multi-$MINER_VERSION
        echo "SRBMiner downloaded successfully!"

    - name: ğŸ”§ Configure Miner
      id: config
      run: |
        cd SRBMiner-Multi-$MINER_VERSION
        cat > mining_config.txt << EOF
        # Wownero Mining Configuration
        Algorithm: randomx
        Pool: $POOL_URL
        Wallet: $WALLET_ADDRESS
        Worker: $WORKER_NAME-$GITHUB_RUN_ID
        Duration: $MINING_DURATION
        TLS: Enabled
        EOF
        echo "âœ… Configuration file created"

    - name: â›ï¸ Start Mining Session
      id: mining
      timeout-minutes: 320  # 5 Ø³Ø§Ø¹Øª + 20 Ø¯Ù‚ÛŒÙ‚Ù‡ buffer
      run: |
        cd SRBMiner-Multi-$MINER_VERSION
        echo "â›ï¸ Starting Wownero mining session..."
        echo "â° Duration: $MINING_DURATION"
        echo "ğŸ’° Mining to: $WALLET_ADDRESS"
        
        # Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø§ÛŒÙ†Ø± Ø¨Ø§ timeout
        timeout $MINING_DURATION ./SRBMiner-MULTI \
          --algorithm randomx \
          --pool $POOL_URL \
          --wallet $WALLET_ADDRESS \
          --worker $WORKER_NAME-$GITHUB_RUN_ID \
          --tls true \
          --cpu-threads 2 \
          --disable-gpu \
          --log-file mining.log \
          --retry-time 10
        
        MINING_EXIT_CODE=$?
        echo "MINING_EXIT_CODE=$MINING_EXIT_CODE" >> $GITHUB_ENV
        
        if [ $MINING_EXIT_CODE -eq 124 ]; then
          echo "âœ… Mining completed successfully (timeout reached)"
        else
          echo "âš ï¸ Mining stopped with exit code: $MINING_EXIT_CODE"
        fi

    - name: ğŸ“Š Collect Mining Statistics
      if: always()
      id: stats
      run: |
        cd SRBMiner-Multi-$MINER_VERSION
        echo "ğŸ“Š Collecting mining statistics..."
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ù„Ø§Ú¯
        if [ -f mining.log ]; then
          TOTAL_HASHES=$(grep -o "Total hashes: [0-9]*" mining.log | tail -1 | awk '{print $3}' || echo "0")
          ACCEPTED_SHARES=$(grep -o "Accepted shares: [0-9]*" mining.log | tail -1 | awk '{print $3}' || echo "0")
          REJECTED_SHARES=$(grep -o "Rejected shares: [0-9]*" mining.log | tail -1 | awk '{print $3}' || echo "0")
          
          echo "TOTAL_HASHES=${TOTAL_HASHES:-0}" >> $GITHUB_ENV
          echo "ACCEPTED_SHARES=${ACCEPTED_SHARES:-0}" >> $GITHUB_ENV
          echo "REJECTED_SHARES=${REJECTED_SHARES:-0}" >> $GITHUB_ENV
        else
          echo "TOTAL_HASHES=0" >> $GITHUB_ENV
          echo "ACCEPTED_SHARES=0" >> $GITHUB_ENV
          echo "REJECTED_SHARES=0" >> $GITHUB_ENV
        fi
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "DURATION_SECONDS=$DURATION" >> $GITHUB_ENV

    - name: ğŸ”„ Verify Wallet Transfer
      id: verify
      run: |
        echo "ğŸ” Verifying wallet address and pool status..."
        echo "ğŸ’° Target Wallet: $WALLET_ADDRESS"
        echo "ğŸŠ Pool: $POOL_URL"
        echo "ğŸ‘· Worker: $WORKER_NAME-$GITHUB_RUN_ID"
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø¯Ø±Ø³ ÙˆÙ„Øª
        if [[ ${#WALLET_ADDRESS} -ne 99 ]]; then
          echo "âŒ Invalid wallet address length"
          exit 1
        fi
        
        echo "âœ… Wallet address validation passed"

    - name: ğŸ“ˆ Generate Mining Report
      if: always()
      id: report
      run: |
        echo "ğŸ“ˆ Generating mining report..."
        cat << EOF
        ğŸš€ WOWNERO MINING REPORT
        =========================
        ğŸ“… Run ID: $GITHUB_RUN_ID
        â±ï¸  Duration: $((DURATION_SECONDS / 60)) minutes
        ğŸ’° Wallet: ${WALLET_ADDRESS:0:20}...${WALLET_ADDRESS: -20}
        ğŸŠ Pool: $POOL_URL
        ğŸ‘· Worker: $WORKER_NAME-$GITHUB_RUN_ID
        
        ğŸ“Š PERFORMANCE METRICS:
        -------------------------
        âœ… Accepted Shares: $ACCEPTED_SHARES
        âŒ Rejected Shares: $REJECTED_SHARES
        ğŸ”¢ Total Hashes: $TOTAL_HASHES
        
        ğŸ’¡ NOTE:
        -------------------------
        All mined WOW are automatically sent to the specified wallet.
        Pool payout occurs when minimum threshold is reached.
        Check pool dashboard for detailed statistics.
        EOF

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up temporary files..."
        rm -rf SRBMiner-Multi-*
        echo "âœ… Cleanup completed"

  monitoring:
    needs: mine-and-transfer
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“± Send Notification
      if: always()
      run: |
        echo "ğŸ“± Mining session completed!"
        echo "Workflow: $GITHUB_WORKFLOW"
        echo "Result: ${{ job.status }}"
        echo "View logs: https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
